<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real time chat</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../static/chat.css">
</head>


<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io({
        auth: {
            token: localStorage.getItem('token')
        }
    });

</script>
<body class="bg-blue-50 flex flex-col items-center justify-center min-h-screen">
    <div class="main bg-white p-8 rounded w-full flex">
        <div class="mini-shadow w-1/4 bg-gray-100 p-4 rounded mr-4">
            <div class="mt-4">
                <form action="/search-users" method="post" class="search-form">
                    <input type="text" name="query" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-200" placeholder="Search user with ID">
                </form>
            </div>

            <ul class="users  mt-3">
                
            </ul>
        </div>
        <!-- Основной контент чата -->
        <div class="w-3/4 inner-main">
             <div class="user-info mini-shadow flex justify-between items-center mb-2 rounded bg-gray-100 p-1">
                
            </div>
            <div class="chat-container">
                <div class="inner-chat-container mini-shadow overflow-y-auto p-4 border rounded">
          
                    <div class="mb-4 chat">
                        
                    </div>
                   
                </div>
            </div>
            <div class="wrap__form-send-message">

            </div>
            
        </div>
    </div>
</body>


<script>
    socket.on('chat message', (message, date_created) => {
        $('.chat').append(`
            <div class="wrap__my-message">
                <div class="my-message mb-2">
                    <p class="text-gray-700 message-text">${message}</p>
                    <li class="date-message">${new Date(date_created).toLocaleTimeString().slice(0, 5)}</li>
                </div>
            </div>
        `)
        
        let chatH = 0
        const myMesagesH = $('.chat > *')
        for(i of myMesagesH){
            chatH += $(i).height()
        }
        $('.inner-chat-container').scrollTop(chatH)
    })
    
    const url = window.location.href.split('/chat/')[1]

    $('.search-form').keydown(e => {
        setTimeout(() => {
            const form = $(e.currentTarget)
            
            $.ajax({
                url: "/search-users",
                method: 'post',
                data: form.serialize(),
                headers: {
                    'Authorization': `Bearer ${localStorage.token}`
                },
                success: res => {
                    $('.users > *').remove()
                    if(res.users.length > 0){
                        for(i of res.users){
                            if(i._id === url){
                                $('.users').append(`
                                <div class="get-chat">
                                    <a href="/chat/${i._id}" class="user-btn active-user">${i.username}</a>
                                </div>
                            `)
                            }else{
                                $('.users').append(`
                                    <div class="get-chat">
                                        <a href="/chat/${i._id}" class="user-btn user">${i.username}</a>
                                    </div>
                                `)
                            }
                        }
                    }else{
                        console.log(res)
                        $('.users').append(`
                            <div class="not-found-search bg-amber-200">
                                <center>
                                    <h2>Not found...</h2>
                                </center>
                            </div>
                        `)
                    }
                }
            })
        }, 0)
    })

    $.ajax({
        url: `/chat-data/${url}`,
        method: 'get',
        headers: {
            'Authorization': `Bearer ${localStorage.token}`
        },
        success: res => {
            if(res.messages.length > 0){
                for(i of res.messages){
                    if(i.sender === res.userNow){
                        $('.chat').append(`
                        <div class="wrap__my-message">
                            <div class="my-message mb-2">
                                <p class="text-gray-700 message-text">${i.text}</p>
                                <li class="date-message">${new Date(i.date_created).toLocaleTimeString().slice(0, 5)}</li>
                            </div>
                        </div>
                    `)
                    }else{
                        $('.chat').append(`
                            <div class="wrap__user-message">
                                <div class="user-message mb-2">
                                    <p class="text-gray-700 message-text">${i.text}</p>
                                    <li class="date-message">${new Date(i.date_created).toLocaleTimeString().slice(0, 5)}</li>
                                </div>
                            </div>
                        `)
                    }
                }
            }
            $('.user-info > *').remove()
            $('.wrap__form-send-message > *').remove()

            //         OTHER  
            $('.user-info').addClass('mb-2')
            $('.chat-container').addClass('mb-4')


            $('.user-info').append(`
                <h1 class="text-2xl">${res.recipient.username}</h1>
                <div class="flex items-center">
                    <p>@${res.recipient.uniqueUsername}</p>
                </div>
            `)
           
            $('.wrap__form-send-message').append(`
                <form class="form-send-message flex items-center" method="post" action="/send-message/${res.recipient._id}">
                    <input type="text" name="message" class="input-send mini-shadow appearance-none border rounded w-full px-4 text-gray-700 mr-4 leading-tight focus:outline-none" placeholder="Message...">
                    <button type="submit" class="button-send-message mini-shadow text-white font-bold px-4 rounded focus:outline-none w-1/4">Send</button>
                </form>
            `)

            let chatH = 0
            const myMesagesH = $('.chat > *')
            for(i of myMesagesH){
                chatH += $(i).height()
            }
            $('.inner-chat-container').scrollTop(chatH)

            $('.form-send-message').submit(e => {
                e.preventDefault()
                const form = $(e.currentTarget)
           
                $.ajax({
                    url: form.attr('action'),
                    method: 'post',
                    data: form.serialize(),
                    headers: {
                        'Authorization': `Bearer ${localStorage.token}`
                    },
                    success: res => {
                        if(res.ok){
                            socket.emit('chat message', res.message, res.createdAt)
                            
                            
                            $('.input-send').val('')
                        }
                    }
                })
            })
        }
    })

   $.ajax({
        url: "/acquaintances",
        method: "get",
        headers: {
            'Authorization': `Bearer ${localStorage.token}`
        },
        success: res => {
            if(res.users){
                for(i of res.users){
                    if(i._id === url){
                        $('.users').append(`
                        <div class="get-chat">
                            <a href="/chat/${i._id}" class="user-btn active-user">${i.username}</a>
                        </div>
                    `)
                    }else{
                        $('.users').append(`
                            <div class="get-chat">
                                <a href="/chat/${i._id}" class="user-btn user">${i.username}</a>
                            </div>
                        `)
                    }
                }
                
           
            }
        }
   })
</script>
</html>