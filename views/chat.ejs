<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real time chat</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" id="theme-link" href="../static/chatLightMode.css">
</head>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io({
        auth: {
            token: localStorage.getItem('token')
        }
    });
</script>

<body class="flex flex-col items-center justify-center min-h-screen">
    <div class="wrap__alert">

    </div>
    <header class="header">
        <div class="inner-header rounded mb-2 px-8 py-2 flex">
            <div class="header-logo mr-8">
                <a href="/" class="header-link-logo-svg">
                    <svg viewBox="0 0 24 24" class="header-logo-svg"  fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path fill-rule="evenodd" clip-rule="evenodd" d="M16.5 7.063C16.5 10.258 14.57 13 12 13c-2.572 0-4.5-2.742-4.5-5.938C7.5 3.868 9.16 2 12 2s4.5 1.867 4.5 5.063zM4.102 20.142C4.487 20.6 6.145 22 12 22c5.855 0 7.512-1.4 7.898-1.857a.416.416 0 0 0 .09-.317C19.9 18.944 19.106 15 12 15s-7.9 3.944-7.989 4.826a.416.416 0 0 0 .091.317z" fill="#383838"></path></g></svg>
                </a>
            </div>
            <nav class="nav">
                <ul class="list-items">
                    <li class="list-item">
                        <a href="#" class="link-item">Lorem</a>
                    </li>
                    <li class="list-item">
                        <a href="#" class="link-item">Lorem</a>
                    </li>
                    <li class="list-item">
                        <a href="#" class="link-item">Lorem</a>
                    </li>
                </ul>
            </nav>
            <div class="right-menu-header">
                <div class="inner-right-menu-header">
                    <a href="#" class="link-right-menu-header">

                    </a>
                </div>
            </div>
        </div>
    </header>
    <div class="main p-8 rounded w-full flex">
        <div class="left-side mini-shadow w-1/4 p-4 rounded mr-4">
            <div class="menu-search mt-4 flex">
                <a href="#" class="a__svg-menu">
                    <svg viewBox="0 0 24 24" class="svg-menu" fill="rgb(36, 19, 16)" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M4 6H20M4 12H20M4 18H20" stroke="#3fa695" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                </a>
                <form action="/search-users" method="post" class="search-form">
                    <input type="text" name="query" class="w-full px-3 py-2 border rounded focus:outline-none" placeholder="Search user with ID">
                </form>
            </div>

            <ul class="users  mt-3">
                
            </ul>
            <div id="drawer" class="drawer">
                <div class="menu">
                    <div class="inner-menu">
                        <div class="text-menu">
                            <center>
                                <h4 class="menu-name">Menu</h4>
                            </center>
                        </div>
                        <div class="links">
                            <a href="/create-chat" class="menu-link create-chat-link">Create chat</a>
                        </div>
                        <form method="get" action="/darkmode" class="toggle-container">
                            <p class="dark-mode-text">Dark mode</p>
                            <input type="checkbox" name="darkmode" id="dark-mode-toggle">
                            <label for="dark-mode-toggle"></label>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-svg-load">

        </div>
        <!-- Основной контент чата -->
        <div class="w-3/4 inner-main">
            <div class="user-info mini-shadow flex justify-between items-center mb-2 rounded">
                
            </div>
            <div class="chat-container">
                <div class="inner-chat-container mini-shadow overflow-y-auto p-4 rounded">
          
                    <div class="mb-4 chat">
                        
                    </div>
                   
                </div>
            </div>
            <div class="wrap__form-send-message">

            </div>
        </div>
    </div>
</body>

<div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
</div>

  

<script>
    if(!localStorage.token){
        window.location.href = '/registration'
    }
    

    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const themeLink = document.getElementById('theme-link');
    
    function darkOff(){
        localStorage.setItem('darkmode', -1)
        themeLink.href = '../static/chatLightMode.css';
        $('.link-right-menu-header > *').remove()
        $('.link-right-menu-header').append(`
            <svg viewBox="0 0 24 24" class="svg-right-menu-header" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M7 12C7 13.1046 6.10457 14 5 14C3.89543 14 3 13.1046 3 12C3 10.8954 3.89543 10 5 10C6.10457 10 7 10.8954 7 12Z" fill="#1C274C"></path> <path d="M14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12Z" fill="#1C274C"></path> <path d="M21 12C21 13.1046 20.1046 14 19 14C17.8954 14 17 13.1046 17 12C17 10.8954 17.8954 10 19 10C20.1046 10 21 10.8954 21 12Z" fill="#1C274C"></path> </g></svg>
        `)
        $('.header-link-logo-svg > *').remove()
        $('.header-link-logo-svg').append(`
            <svg viewBox="0 0 24 24" class="header-logo-svg"  fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path fill-rule="evenodd" clip-rule="evenodd" d="M16.5 7.063C16.5 10.258 14.57 13 12 13c-2.572 0-4.5-2.742-4.5-5.938C7.5 3.868 9.16 2 12 2s4.5 1.867 4.5 5.063zM4.102 20.142C4.487 20.6 6.145 22 12 22c5.855 0 7.512-1.4 7.898-1.857a.416.416 0 0 0 .09-.317C19.9 18.944 19.106 15 12 15s-7.9 3.944-7.989 4.826a.416.416 0 0 0 .091.317z" fill="#383838"></path></g></svg>
        `)
    }
    function darkOn(){
        localStorage.setItem('darkmode', 52)
        themeLink.href = '../static/chatDarkMode.css';
        $('.link-right-menu-header > *').remove()
        $('.link-right-menu-header').append(`
            <svg viewBox="0 0 24 24" class="svg-right-menu-header" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M7 12C7 13.1046 6.10457 14 5 14C3.89543 14 3 13.1046 3 12C3 10.8954 3.89543 10 5 10C6.10457 10 7 10.8954 7 12Z" fill="#ededed"></path> <path d="M14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12Z" fill="#ededed"></path> <path d="M21 12C21 13.1046 20.1046 14 19 14C17.8954 14 17 13.1046 17 12C17 10.8954 17.8954 10 19 10C20.1046 10 21 10.8954 21 12Z" fill="#ededed"></path> </g></svg>
        `)
        $('.header-link-logo-svg > *').remove()
        $('.header-link-logo-svg').append(`
            <svg viewBox="0 0 24 24" class="header-logo-svg"  fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path fill-rule="evenodd" clip-rule="evenodd" d="M16.5 7.063C16.5 10.258 14.57 13 12 13c-2.572 0-4.5-2.742-4.5-5.938C7.5 3.868 9.16 2 12 2s4.5 1.867 4.5 5.063zM4.102 20.142C4.487 20.6 6.145 22 12 22c5.855 0 7.512-1.4 7.898-1.857a.416.416 0 0 0 .09-.317C19.9 18.944 19.106 15 12 15s-7.9 3.944-7.989 4.826a.416.416 0 0 0 .091.317z" fill="#f0f0f0"></path></g></svg>
        `)
    }

    if(localStorage.darkmode === '52'){
        darkModeToggle.checked = true
        darkOn()
    }
    if(localStorage.darkmode === '-1'){
        darkOff()
    }
    
    darkModeToggle.addEventListener('change', function() {
        if (darkModeToggle.checked) {
            darkOn()
        } else {
            darkOff()
        }
    });

    socket.on('user message', (message) => {
        $('.chat').append(`
            <div class="wrap__my-message">
                <div class="my-message mb-2">
                    <p class="message-text">${message.text}</p>
                    <li class="date-message">${new Date(message.date_created).toLocaleTimeString().slice(0, 5)}</li>
                </div>
            </div>
        `)

        let chatH = 0
        const myMesagesH = $('.chat > *')
        for(i of myMesagesH){
            chatH += $(i).height()
        }
        $('.inner-chat-container').scrollTop(chatH)
    })
    socket.on('chat message', (message, sender) => {
        $('.chat').append(`
            <div class="wrap__my-message">
                <div class="my-message mb-2">
                    <div class="name-container">
                        <p class="message-text">${message.text}</p>
                    </div>
                    <li class="date-message">${new Date(message.date_created).toLocaleTimeString().slice(0, 5)}</li>
                </div>
            </div>
        `)

        let chatH = 0
        const myMesagesH = $('.chat > *')
        for(i of myMesagesH){
            chatH += $(i).height()
        }
        $('.inner-chat-container').scrollTop(chatH)
    })
    //      SOCKET END          //           //
    const url = window.location.href.split('/chat/')[1]

    $('.search-form').keydown(e => {
        setTimeout(() => {
            const form = $(e.currentTarget)
            
            $.ajax({
                url: "/search-users",
                method: 'post',
                data: form.serialize(),
                headers: {
                    'Authorization': `Bearer ${localStorage.token}`
                },
                success: res => {
                    $('.users > *').remove()
                    if(res.users.length > 0){
                        for(i of res.users){
                            if(i._id === url){
                                $('.users').append(`
                                    <a href="/chat/${i._id}" class=" user-btn">
                                        <div class="get-user active-user get-user-${url}">
                                            <div class="wrap__user-avatar">
                                                <img src="${i.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : i.avatar}" alt="User avatar" class="user-avatar ${i.avatar === undefined ? 'no-avatar' : ''}">
                                            </div>
                                            <div class="username">
                                                ${i.username}
                                            </div>
                                        </div> 
                                    </a>
                                `)
                               
                            }else{
                                $('.users').append(`
                                    <a href="/chat/${i._id}" class=" user-btn">
                                        <div class="get-user get-user-${url}">
                                            <div class="wrap__user-avatar">
                                                <img src="${i.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : i.avatar}" alt="User avatar" class="user-avatar ${i.avatar === undefined ? 'no-avatar' : ''}">
                                            </div>
                                            <div class="username">
                                                ${i.username}
                                            </div>
                                        </div> 
                                    </a>
                                `)
                            }
                        }
                    }if (res.chats.length > 0){
                       
                    for(i of res.chats){
                        if(i._id === url){
                            $('.users').append(`
                                <a href="/chat/${i._id}" class=" user-btn">
                                    <div class="get-user active-user get-user-${url}">
                                        <div class="wrap__user-avatar">
                                            <img src="${i.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : i.avatar}" alt="User avatar" class="user-avatar ${i.avatar === undefined ? 'no-avatar' : ''}">
                                        </div>
                                        <div class="username">
                                            ${i.chatName}
                                        </div>
                                    </div> 
                                </a>
                            `)
                        }else{
                            $('.users').append(`
                                <a href="/chat/${i._id}" class=" user-btn">
                                    <div class="get-user get-user-${url}">
                                        <div class="wrap__user-avatar">
                                            <img src="${i.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : i.avatar}" alt="User avatar" class="user-avatar">
                                        </div>
                                        <div class="username">
                                            ${i.chatName}
                                        </div>
                                    </div> 
                                </a>
                            `)
                        }
                        
                    }
                    }if(res.users.length < 1 && res.chats.length < 1){
                        $('.users').append(`
                            <div class="not-found-search bg-amber-200">
                                <center>
                                    <h2>Not found...</h2>
                                </center>
                            </div>
                        `)
                    }
                    //    END 
                   
                }
            })
        }, 0)
    })

    $.ajax({
        url: `/user-data/${url}`,
        method: 'get',
        headers: {
            'Authorization': `Bearer ${localStorage.token}`
        },
        success: res => {
            console.log(res)
            if(res.messages){
                if(res.messages.length > 0){
                    for(let i = 0; i < res.messages.length; i++){
                        if(res.messages[i].sender === res.userNow._id || res.messages[i].sender === res.userNow){
                            $('.chat').append(`
                            <div class="wrap__my-message">
                                <div class="my-message mb-2">
                                    <p class="message-text">${res.messages[i].text}</p>
                                    <li class="date-message">${new Date(res.messages[i].date_created).toLocaleTimeString().slice(0, 5)}</li>
                                </div>
                            </div>
                        `)
                        }else{
                            $('.chat').append(`
                                <div class="wrap__user-message">
                                    <div class="user-message mb-2">
                                        <div class="name-container">
                                            <p class="message-text-name">${res.recipient.username}</p>
                                            <p class="message-text">${res.messages[i].text}</p>
                                        </div>
                                        <li class="date-message">${new Date(res.messages[i].date_created).toLocaleTimeString().slice(0, 5)}</li>
                                    </div>
                                </div>
                            `)
                        }
                    }
                }                    

                $('.user-info > *').remove()
                $('.wrap__form-send-message > *').remove()
    
                //         OTHER  
                $('.user-info').addClass('mb-2')
                $('.chat-container').addClass('mb-2')
    
                $('.user-info').append(`
                    <div class="user-info__username">
                        <h1 class="text-2xl h1-user-info">${res.recipient.username}</h1>
                        <div class="wrap__user-avatar">
                            <img src="${res.recipient.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : res.recipient.avatar}" alt="User avatar" class="user-avatar ${res.recipient.avatar === undefined ? 'no-avatar' : ''} user-info-avatar">
                        </div>
                    </div>
                    <div class="flex items-center user-info-leave-uniquename">
                        <p class="recipient-unique-username">@${res.recipient.uniqueUsername}</p>
                    </div>
                `)
    
                $('.wrap__form-send-message').append(`
                    <form class="form-send-message flex items-center" method="post" action="/send-message/${res.recipient._id}">
                        <input type="text" name="message" class="input-send mini-shadow appearance-none border rounded w-full px-4  mr-4 leading-tight focus:outline-none" placeholder="Message...">
                        <button type="submit" class="button-send-message mini-shadow text-white font-bold px-4 rounded focus:outline-none w-1/4">Send</button>
                    </form>
                `)
            
               
    
                let chatH = 0
                const myMesagesH = $('.chat > *')
                for(i of myMesagesH){
                    chatH += $(i).height()
                }
                $('.inner-chat-container').scrollTop(chatH)
    
                $('.form-send-message').submit(e => {
                    e.preventDefault()
                    const form = $(e.currentTarget)
               
                    $.ajax({
                        url: form.attr('action'),
                        method: 'post',
                        data: form.serialize(),
                        headers: {
                            'Authorization': `Bearer ${localStorage.token}`
                        },
                        success: res => {
                            if(res.ok){
                                socket.emit('user message', res.createdMessage)
                            
                                $('.input-send').val('')
                            }
                        }
                    })
                })
            }

            //     CHAT   CHAT     CHAT       CHAT            CHAT                CHAT                    CHAT
            else{
                if(res.chatRecipient){
                    if(res.chatRecipient.members.includes(res.userNow)){
                        for(let i = 0; i < res.chatData.length; i++){
                            if(res.chatData[i].sender._id === res.userNow._id || res.chatData[i].sender._id === res.userNow){
                                $('.chat').append(`
                                <div class="wrap__my-message">
                                    <div class="my-message mb-2">
                                        <p class="message-text">${res.chatData[i].text}</p>
                                        <li class="date-message">${new Date(res.chatData[i].date_created).toLocaleTimeString().slice(0, 5)}</li>
                                    </div>
                                </div>
                            `)
                            }else{
                                $('.chat').append(`
                                    <div class="wrap__user-message">
                                        <div class="user-message mb-2">
                                            <div class="name-container">
                                                <p class="message-text-name">${res.chatData[i].sender.username}</p>
                                                <p class="message-text">${res.chatData[i].text}</p>
                                            </div>
                                            <li class="date-message">${new Date(res.chatData[i].date_created).toLocaleTimeString().slice(0, 5)}</li>
                                        </div>
                                    </div>
                                `)
                            }
                        }
                    }else{
                        $('.chat').append(`
                            <div class="alert-main w-full mt-4 px-4 py-3 rounded relative" role="alert">
                                <strong class="font-bold">Error:</strong>
                                <span class="block sm:inline">Join the chat to see the message</span>

                            </div>
                        `)
                    }
                }
                
    
                $('.user-info > *').remove()
                $('.wrap__form-send-message > *').remove()
    
                $('.user-info').addClass('mb-2')
                $('.chat-container').addClass('mb-2')
    
                $('.user-info').append(`
                    <div class="user-info__username">
                        <h1 class="text-2xl h1-user-info">${res.chatRecipient.chatName}</h1>
                        <div class="wrap__user-avatar">
                            <img src="${res.chatRecipient.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : res.chatRecipient.avatar}" alt="User avatar" class="user-avatar ${res.chatRecipient.avatar === undefined ? 'no-avatar' : ''} user-info-avatar">
                        </div>
                    </div>
                    <div class="flex items-center user-info-leave-uniquename">
                        <p class="recipient-unique-username">@${res.chatRecipient.uniqueChatName}</p>
                        
                    </div>
                `)
            
                
            
                $.ajax({
                    url: `/is-user-join-chat/${url}`,
                    method: 'get',
                    headers: {
                        'Authorization': `Bearer ${localStorage.token}`
                    },
                    success: res => {
                        if(res.ok === -2){
                            $('.wrap__form-send-message > *').remove()
                            $('.wrap__form-send-message').append(`
                                <div class="wrap-join-button">
                                    <button class="btn-join rounded">Join to chat</button>
                                </div>
                            `)
                            $('.btn-join').click(e => {
                                e.preventDefault()
                                $.ajax({
                                    url: `/join-chat/${url}`,
                                    method: 'get',
                                    headers: {
                                        'Authorization': `Bearer ${localStorage.token}`
                                    },
                                    success: res => {
                                        if(res.message){
                                            $('.wrap__alert').append(`
                                                <div class="alert-main mb-4 px-4 py-3 rounded" role="alert">
                                                    <strong class="font-bold">Error:</strong>
                                                    <span class="block sm:inline">${res.message}</span>
                                                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
                                                        <svg class="svg-close fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                                                    </span>
                                                </div>
                                            `)

                                            $('.wrap__alert').css({'position': 'absolute', 'top': '5%', 'right': 'auto'})

                                            $('.svg-close').click(e => {
                                                e.preventDefault()
                                                $('.wrap__alert').css({'position': "static"})
                                                $('.wrap__alert > *').remove()
                                            })
                                        }else{
                                            socket.emit('join room', res.uniqueChatName)
                                            
                                            $('.wrap__form-send-message > *').remove()
                                            $('.wrap__form-send-message').append(`
                                                <form class="form-send-message flex items-center" method="post" action="/send-message/${url}">
                                                    <input type="text" name="message" class="input-send mini-shadow appearance-none border rounded w-full px-4 text-gray-700 mr-4 leading-tight focus:outline-none" placeholder="Message...">
                                                    <button type="submit" class="button-send-message mini-shadow text-white font-bold px-4 rounded focus:outline-none w-1/4">Send</button>
                                                </form>
                                            `)
                                            $('.form-send-message').submit(e => {
                                                e.preventDefault()
                                                const form = $(e.currentTarget)
                                
                                                $.ajax({
                                                    url: form.attr('action'),
                                                    method: "post",
                                                    headers: {
                                                        'Authorization': `Bearer ${localStorage.token}`
                                                    },
                                                    data: form.serialize(),
                                                    success: res => {
                                                        if(res.ok){
                                                            socket.emit('message room', res.room, res.createdMessage, res.sender)
                                
                                                            $('.input-send').val('')
                                                        }
                                                    }
                                                })
                                            })
                                            window.location.href = `/chat/${url}`   
                                        }
                                    }
                                })
                            })
                        }

                        else if(res.message){
                            $('.wrap__alert').append(`
                                <div class="alert-main mb-4 px-4 py-3 rounded relative" role="alert">
                                    <strong class="font-bold">Error:</strong>
                                    <span class="block sm:inline">${res.message}</span>
                                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
                                        <svg class="svg-close fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                                    </span>
                                </div>
                            `)
                            $('.svg-close').click(e => {
                                e.preventDefault()
                                $('.wrap__alert').remove()
                            })
                        }

                        else{
                            $('.user-info-leave-uniquename').append(`
                                <button class="btn-leave rounded">Leave</button>
                            `)
                        $('.btn-leave').click(e => {
                            $.ajax({
                                url: `/leave/${url}`,
                                method: "get",
                                headers: {
                                    'Authorization': `Bearer ${localStorage.token}`
                                },
                                success: res => {
                                    
                                    if(res.message){
                                        $('.wrap__alert').append(`
                                            <div class="alert-main mb-4 px-4 py-3 rounded relative" role="alert">
                                                <strong class="font-bold">Error:</strong>
                                                <span class="block sm:inline">${res.message}</span>
                                                <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
                                                    <svg class="svg-close fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                                                </span>
                                            </div>
                                        `)
                                    }else{
                                        window.location.href = `/chat/${url}`
                                    }   
                                                             
                                }
                            })
                        })
                        
                            //            //             //
                            $('.wrap__form-send-message > *').remove()
                            $('.wrap__form-send-message').append(`
                                <form class="form-send-message flex items-center" method="post" action="/send-message/${url}">
                                    <input type="text" name="message" class="input-send mini-shadow appearance-none border rounded w-full px-4 text-gray-700 mr-4 leading-tight focus:outline-none" placeholder="Message...">
                                    <button type="submit" class="button-send-message mini-shadow text-white font-bold px-4 rounded focus:outline-none w-1/4">Send</button>
                                </form>
                            `)
                            $('.form-send-message').submit(e => {
                            e.preventDefault()
                            const form = $(e.currentTarget)
            
                            $.ajax({
                                url: form.attr('action'),
                                method: "post",
                                headers: {
                                    'Authorization': `Bearer ${localStorage.token}`
                                },
                                data: form.serialize(),
                                success: res => {
                                    if(res.ok){
                                        socket.emit('message room', res.room, res.createdMessage, res.sender)
            
                                        $('.input-send').val('')
                                    }
                                }
                            })
                        })
                        }
                    }
                })
            }

            let chatH = 0
            const myMesagesH = $('.chat > *')
            for(i of myMesagesH){
                chatH += $(i).height()
            }
            $('.inner-chat-container').scrollTop(chatH)
            //      END             END                  END
            
        }
    })

   $.ajax({
        url: "/acquaintances",
        method: "get",
        headers: {
            'Authorization': `Bearer ${localStorage.token}`
        },
        success: res => {
            if(res.users.length > 0){
                for(i of res.users){
                    if(i._id === url){
                        $('.users').append(`
                            <a href="/chat/${i._id}" class=" user-btn">
                                <div class="get-user active-user get-user-${url}">
                                    <div class="wrap__user-avatar">
                                        <img src="${i.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : i.avatar}" alt="User avatar" class="user-avatar ${i.avatar === undefined ? 'no-avatar' : ''}">
                                    </div>
                                    <div class="username">
                                        ${i.username}
                                    </div>
                                </div> 
                            </a>
                        `)
             
                    }else{
                        $('.users').append(`
                            <a href="/chat/${i._id}" class=" user-btn">
                                <div class="get-user get-user-${url}">
                                    <div class="wrap__user-avatar">
                                        <img src="${i.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : i.avatar}" alt="User avatar" class="user-avatar ${i.avatar === undefined ? 'no-avatar' : ''}">
                                    </div>
                                    <div class="username">
                                        ${i.username}
                                    </div>
                                </div> 
                            </a>
                        `)
                    }
                }
            }
            if(res.chats.length > 0){
                for(i of res.chats){
                    if(i._id === url){
                        $('.users').append(`
                            <a href="/chat/${i._id}" class=" user-btn">
                                <div class="get-user active-user get-user-${url}">
                                    <div class="wrap__user-avatar">
                                        <img src="${i.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : i.avatar}" alt="User avatar" class="user-avatar ${i.avatar === undefined ? 'no-avatar' : ''}">
                                    </div>
                                    <div class="username">
                                        ${i.chatName}
                                    </div>
                                </div> 
                            </a>
                        `)
                    }else{
                        $('.users').append(`
                            <a href="/chat/${i._id}" class=" user-btn">
                                <div class="get-user get-user-${url}">
                                    <div class="wrap__user-avatar">
                                        <img src="${i.avatar === undefined ? '/userAvatars/user-question-alt-svgrepo-com.png' : i.avatar}" alt="User avatar" class="user-avatar ${i.avatar === undefined ? 'no-avatar' : ''}">
                                    </div>
                                    <div class="username">
                                        ${i.chatName}
                                    </div>
                                </div> 
                            </a>
                        `)
                    }
                    
                }
            }
            
            const drawer = $('#drawer');
            const svgMenu = $('.a__svg-menu');

            svgMenu.click(function(e) {
                e.preventDefault();
                
                drawer.toggleClass('open');

                $('.create-chat-link').click(e => {
                    e.preventDefault()
  
                    $('.inner-main > *').remove()
                    $('.inner-main').append(`
                        <div class="create-chat-container p-8 rounded shadow w-full h-full flex flex-col">
                            <span class="absolute svg-close-create-chat">
                                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                            </span>
                            <h1 class="create-chat-h1 text-center text-2xl font-bold">Create chat</h1>
                            <div class="wrap__alert-chat-create">
                
                            </div>
                            <form action="/create-chat" method="post" enctype="multipart/form-data" class="form-create-chat flex flex-col h-full">
                                <div class="mb-3">
                                    <label for="chatName" class="lable-create-chat block text-sm font-bold mb-2">Chat name</label>
                                    <input type="chatName" name="chatName" id="chatName" class="input-create-chat appearance-none border rounded w-full py-2 px-3  leading-tight focus:outline-none focus:shadow-outline" required>
                                </div>
                                <div class="mb-3 uniqueChatName-container">
                                    <label for="uniqueChatName" class="lable-create-chat block text-sm font-bold mb-2">Unique chat name</label>
                                    <input type="text" name="uniqueChatName" id="uniqueChatName" class="input-create-chat uniqueChatName appearance-none border rounded w-full py-2 px-3  leading-tight focus:outline-none focus:shadow-outline" required>
                                </div>
                                <div class="mb-3 max-users-container">
                                    <label for="max-users" class="lable-create-chat block text-sm font-bold mb-2">Max users in chat</label>
                                    <input type="number" name="maxUsers" id="max-users" class="input-create-chat max-users appearance-none border rounded w-full py-2 px-3  leading-tight focus:outline-none focus:shadow-outline">
                                </div>
                                <div class="mb-3 avatar-container">
                                    <label for="avatar" class="label-avatar block text-sm font-bold mb-2">Avatar</label>
                                    <label class="input-file w-full">
                                            <input type="file" name="chatAvatar">		
                                            <span class="w-full">Choose file</span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between mt-auto">
                                    <button type="submit" class="button-submit-create-chat w-full text-white font-bold py-3 px-4 rounded focus:outline-none focus:shadow-outline">Create</button>
                                </div>
                            </form>
                        </div>
                    `)

                    $('.input-file input[type=file]').on('change', function(){
                        let file = this.files[0];
                        $(this).next().html(file.name);
                    });

                    $('.svg-close-create-chat').click(e => {
                        window.location.href = `/chat/${url}` 
                    })

                    $('.uniqueChatName').keydown(e => {
                        setTimeout(() => {
                            const form = $(e.currentTarget)
                            $.ajax({
                                url: "/confirm-unique-chatname",
                                method: "post",
                                headers: {
                                    'Authorization': `Bearer ${localStorage.token}`
                                },
                                data: form.serialize(),
                                success: res => {
                                    if(!res.ok){
                                        $('.alert-confirm-uniqueChat').remove()
                             
                                        $('.button-submit-create-chat').prop('disabled', true);
            
                                        $('.uniqueChatName-container').append(`
                                            <li class="alert-confirm-uniqueChat" style="list-style: none; font-size: 13px; color: #ff5555; margin-top: 3px">${res.message}</li>
                                        `)
                                    }else{
                                        $('.alert-confirm-uniqueChat').remove()
                                        $('.button-submit-create-chat').prop('disabled', false);
            
                                        $('.uniqueChatName-container').append(`
                                            <li class="alert-confirm-uniqueChat" style="list-style: none; font-size: 13px; color: #45d7a2; margin-top: 3px">Unique chat name is available!</li>
                                        `)
                                    }
                                }
                            })
                        }, 0)
                    })

                    $('.form-create-chat').submit(function(e) {
                        e.preventDefault();
                    
                        var form = this; // Теперь 'this' ссылается на DOM элемент формы
                        var formData = new FormData(); // Создаем пустой объект FormData
                    
                        // Добавляем данные из формы в FormData
                        for (var pair of new FormData(form).entries()) {
                            formData.append(pair[0], pair[1]);
                        }
                    
                        $.ajax({
                            url: form.action, // URL, указанный в атрибуте action формы
                            type: form.method, // Метод запроса, указанный в атрибуте method формы
                            data: formData,
                            contentType: false, // Не устанавливать заголовок Content-Type
                            processData: false, // Не обрабатывать данные формы
                            headers: {
                                'Authorization': `Bearer ${localStorage.token}`
                            },
                            success: res => {
                                console.log(res)
                                if(res.ok){
                                    socket.emit('join room', uniqueChatName)
                                    window.location.href = '/'
                                }else{
                                    $('.wrap__alert-chat-create').append(`
                                        <div class="alert-confirm-uniqueUsername bg-red-100 mb-4 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                                            <strong class="font-bold">Error:</strong>
                                            <span class="block sm:inline">${res.message}</span>
                                            <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
                                                <svg class="svg-close fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                                            </span>
                                        </div>
                                    `)
                                    $('.svg-close').click(e => {
                                        e.preventDefault()
                                        $('.wrap__alert-chat-create > *').remove()
                                    })
                                }
                            }
                        })
                    })
                    
                   })
            });
            
            drawer.mouseleave(() => {
                drawer.removeClass('open')
            })

            
        }
   })
</script>
</html>